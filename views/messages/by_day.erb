<table class="messages">
  <% @counter = 0 %>
  <% @messages.each_with_index do |m, i| %>
    <% if m.message_type == 'status' %>
      <% if @counter == 0 %>
        <tbody class="collapsed" data-count="">
      <% end %>

      <% @counter += 1 %>
    <% else %>
      <% if @counter != 0 %>
        </tbody>
        <tbody class="after-collapsed" data-count="<%= @counter %>"></tbody>
      <% end %>

      <% @counter = 0 %>
    <% end %>

    <tr class="message <%= 'message-status' if m.message_type == 'status'%>">
      <!-- <%= @counter %> -->
      <!-- <%= m.id %> -->
      <% if m.message_type == 'status' %>
        <td>
          <span class="message-timestamp"><%= m.created_at.strftime('%H:%M:%S') %></span>
        </td>
        <td>
          <div class="message-body"><%= m.from %> is now <%= m.body %></div>
        </td>
      <% else %>
        <td>
          <span class="message-from"><a name="<%= i %>"></a><%= m.from %></span>
          <span class="message-timestamp"><a href="#<%= i %>"><%= m.created_at.strftime('%H:%M:%S') %></a></span>
        </td>
        <td>
          <div class="message-body"><%= m.message_type == 'text' ? escape_text_message(m.body) : m.body %></div>
        </td>
      <% end %>
    </tr>
  <% end %>
      
  <% if @counter != 0 %>
    </tbody>
    <tbody class="after-collapsed" data-count="<%= @counter %>"></tbody>
  <% end %>
</table>
